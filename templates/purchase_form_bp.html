<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>仕入れ入力（Blueprint版）</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        h1 { margin-bottom: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { padding: 6px; border: 1px solid #ccc; }
        .form-row { margin-bottom: 10px; }
        .actions { margin-top: 20px; }
    </style>

    <script>
        // -----------------------------------------
        // 仕入先変更 → 品目一覧を更新 (AJAX /purchase/api/items/<id>)
        // -----------------------------------------
        function loadItems(rowId) {
            const supplierId = document.getElementById("supplier_id_" + rowId).value;
            const itemSelect = document.getElementById("item_id_" + rowId);

            if (!supplierId) {
                itemSelect.innerHTML = "<option value=''>-- 品目を選択 --</option>";
                return;
            }

            fetch(`/purchase/api/items/${supplierId}`)
                .then(res => res.json())
                .then(items => {
                    itemSelect.innerHTML = "<option value=''>-- 品目を選択 --</option>";
                    for (const it of items) {
                        const opt = document.createElement("option");
                        opt.value = it.id;
                        opt.text = `${it.code} | ${it.name}`;
                        itemSelect.appendChild(opt);
                    }
                });
        }
    </script>
</head>

<body>

<h1>仕入れ入力</h1>

<form method="POST" action="{{ url_for('purchase.new_purchase') }}">

    <!-- 店舗選択 -->
    <div class="form-row">
        <label>店舗：</label>
        <select name="store_id">
            <option value="">-- 店舗を選択 --</option>
            {% for s in stores %}
                <option value="{{ s.id }}" {% if selected_store_id == s.id %}selected{% endif %}>
                    {{ s.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- 明細入力 1〜5 行 -->
    <table>
        <thead>
            <tr>
                <th>日付</th>
                <th>仕入先</th>
                <th>品目</th>
                <th>数量</th>
                <th>単価</th>
            </tr>
        </thead>
        <tbody>
            {% for i in range(1, 6) %}
            <tr>
                <td>
                    <input type="date" name="detail_date_{{ i }}">
                </td>
                <td>
                    <select name="supplier_id_{{ i }}" id="supplier_id_{{ i }}"
                            onchange="loadItems({{ i }})">
                        <option value="">-- 仕入先 --</option>
                        {% for sp in suppliers %}
                        <option value="{{ sp.id }}">{{ sp.name }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <select name="item_id_{{ i }}" id="item_id_{{ i }}">
                        <option value="">-- 品目 --</option>
                    </select>
                </td>
                <td><input type="text" name="quantity_{{ i }}" size="5"></td>
                <td><input type="text" name="unit_price_{{ i }}" size="7"></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="actions">
        <button type="submit">登録する</button>
    </div>
</form>


<hr>

<h2>最近の取引（直近 50 件）</h2>

<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>日付</th>
            <th>仕入先</th>
            <th>品目</th>
            <th>数量</th>
            <th>単価</th>
            <th>金額</th>
        </tr>
    </thead>
    <tbody>
        {% for p in purchases %}
        <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.delivery_date }}</td>
            <td>{{ p.supplier_name }}</td>
            <td>{{ p.item_name }}</td>
            <td style="text-align:right">{{ p.quantity }}</td>
            <td style="text-align:right">{{ p.unit_price }}</td>
            <td style="text-align:right">{{ p.amount }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>


</body>
</html>
