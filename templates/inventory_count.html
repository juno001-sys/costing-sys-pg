{% extends "base.html" %}

{% block title %}棚卸し入力{% endblock %}

{% block content %}


<!-- 店舗・日付選択（GET） -->
<form method="get" style="margin-bottom: 12px;">
  <label style="margin-right: 16px;">
    棚卸日：
    <input type="date" name="count_date" value="{{ count_date }}">
  </label>

  <label style="margin-right: 16px;">
    店舗：
    <select name="store_id">
      <option value="">（店舗を選択）</option>
      {% for s in stores %}
        <option value="{{ s.id }}"
                {% if selected_store_id == s.id %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}
    </select>
  </label>

  <button type="submit">表示</button>
</form>

{% if selected_store_id %}
  {% if latest_dates %}
    <p>
      直近棚卸し日：
      {% for d in latest_dates %}
        <a href="{{ url_for('inventory_count',
                            store_id=selected_store_id,
                            count_date=d) }}">
          {{ d }}
        </a>{% if not loop.last %} / {% endif %}
      {% endfor %}
    </p>
  {% endif %}
{% endif %}

{% if not selected_store_id %}
  <p>店舗を選択して「表示」を押すと、棚卸し対象の品目が表示されます。</p>
{% endif %}

{% if items %}
  <!-- 棚卸し登録フォーム（POST） -->
  <form method="post" id="inventory-form">
    <input type="hidden" name="store_id" value="{{ selected_store_id }}">
    <input type="hidden" name="count_date" value="{{ count_date }}">
    <input type="hidden" name="row_count" id="row_count" value="{{ items|length }}">

    {% set ns = namespace(row_index=0) %}

    {% for zone in zones %}
      {% set zone_items = grouped_items.get(zone, []) %}
      {% if zone_items %}
        <h3 style="margin-top:24px;">{{ zone }}</h3>

        <table class="monthly-table">
          <thead>
            <tr>
              <th>コード</th>
              <th>品目名</th>
              <th class="num">システム在庫</th>
              <th class="num">単価</th>
              <th class="num">在庫金額</th>
              <th class="num">棚卸数（入力）</th>
            </tr>
          </thead>
          <tbody>
          {% for it in zone_items %}
            {% set ns.row_index = ns.row_index + 1 %}
            <tr>
              <td>{{ it.item_code }}</td>
              <td>{{ it.item_name }}</td>
              <td class="num">
                {{ "{:,}".format(it.system_qty) }}
                <input type="hidden"
                       name="item_id_{{ ns.row_index }}"
                       value="{{ it.item_id }}">
                <input type="hidden"
                       name="system_qty_{{ ns.row_index }}"
                       value="{{ it.system_qty }}">
              </td>
              <td class="num">
                {{ "{:,.2f}".format(it.unit_price) if it.unit_price else "" }}
              </td>
              <td class="num">
                {{ "{:,.0f}".format(it.stock_amount) if it.stock_amount else "" }}
              </td>
              <td class="num">
                <input
                  type="text"
                  name="count_qty_{{ ns.row_index }}"
                  value="{{ it.counted_qty if it.counted_qty is not none else '' }}"
                  class="num count-input"
                  data-row="{{ ns.row_index }}"
                  data-col="0"
                  style="width:80px; text-align:right;"
                >
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% endif %}
    {% endfor %}

    <div style="margin-top:16px;">
      <button type="submit">棚卸結果を保存</button>
    </div>
  </form>
{% endif %}

{% endblock %}

{% block body_extra %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const inputs = Array.from(document.querySelectorAll(".count-input"));
  if (!inputs.length) return;

  // data-row, data-col から次の input を探すヘルパー
  function findInput(row, col) {
    return inputs.find(el =>
      el.getAttribute("data-row") == row &&
      el.getAttribute("data-col") == col
    );
  }

  inputs.forEach(input => {
    input.addEventListener("keydown", function (e) {
      const row = parseInt(this.getAttribute("data-row"), 10);
      const col = parseInt(this.getAttribute("data-col"), 10);

      // Enter = 次の入力欄へ
      if (e.key === "Enter") {
        e.preventDefault();
        const currentIndex = inputs.indexOf(this);
        const next = inputs[currentIndex + 1];
        if (next) next.focus();
      }

      // ↓キー = 下の行へ
      if (e.key === "ArrowDown") {
        e.preventDefault();
        const next = findInput(row + 1, col);
        if (next) next.focus();
      }

      // ↑キー = 上の行へ
      if (e.key === "ArrowUp") {
        e.preventDefault();
        const prev = findInput(row - 1, col);
        if (prev) prev.focus();
      }

      // →キー = 次の入力（今は同じ列しかないので Enter と同じ扱い）
      if (e.key === "ArrowRight") {
        e.preventDefault();
        const currentIndex = inputs.indexOf(this);
        const next = inputs[currentIndex + 1];
        if (next) next.focus();
      }

      // ←キー = 前の入力
      if (e.key === "ArrowLeft") {
        e.preventDefault();
        const currentIndex = inputs.indexOf(this);
        const prev = inputs[currentIndex - 1];
        if (prev) prev.focus();
      }
    });
  });

  // 最初の入力欄にフォーカス
  inputs[0].focus();
});
</script>
{% endblock %}
