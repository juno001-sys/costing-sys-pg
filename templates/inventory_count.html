{% extends "base.html" %}

{% block title %}棚卸し入力{% endblock %}

{% block content %}
<form method="post">

  <label>
    棚卸日：
    <input type="date" name="count_date" value="{{ count_date }}">
  </label>

  <label style="margin-left:20px;">
    店舗：
    <select name="store_id">
      {% for s in stores %}
        <option value="{{ s.id }}"
          {% if selected_store_id == s.id %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}
    </select>
  </label>

  <button type="submit">保存</button>

  <table>
    <thead>
      <tr>
        <th>品目コード</th>
        <th>品目名</th>
        <th>棚卸数量</th>
      </tr>
    </thead>
    <tbody>

      {% for row in rows %}
      <tr>
        <td>{{ row.code }}</td>
        <td>{{ row.name }}</td>
        <td>
          <input
            type="number"
            name="count_qty_{{ row.id }}"
            value="{{ row.counted_qty or '' }}"
            class="inventory-nav-input"
            autocomplete="off"
            style="width:80px; text-align:right;"
          >
        </td>
      </tr>
      {% endfor %}

    </tbody>
  </table>

  <button type="submit">保存する</button>

</form>
{% endblock %}

{% block body_extra %}
<script>
document.addEventListener("keydown", function (e) {
    const target = e.target;

    // 棚卸し数量欄だけ操作対象
    if (!target.classList.contains("inventory-nav-input")) return;

    const inputs = Array.from(
      document.querySelectorAll("input.inventory-nav-input")
    );
    const idx = inputs.indexOf(target);
    if (idx < 0) return;

    // -------- Enter（次へ） --------
    if (e.key === "Enter") {
        e.preventDefault();
        const next = inputs[idx + 1];
        if (next) {
            next.focus();
            next.select?.();
        }
    }

    // -------- ↓（ArrowDown → 次へ） --------
    if (e.key === "ArrowDown") {
        e.preventDefault();
        const next = inputs[idx + 1];
        if (next) {
            next.focus();
            next.select?.();
        }
    }

    // -------- ↑（ArrowUp → 前へ） --------
    if (e.key === "ArrowUp") {
        e.preventDefault();
        const prev = inputs[idx - 1];
        if (prev) {
            prev.focus();
            prev.select?.();
        }
    }
});
</script>
{% endblock %}
