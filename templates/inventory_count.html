<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>棚卸し入力</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 20px;
      }
      h1 {
        font-size: 22px;
        margin-bottom: 8px;
      }
      a {
        text-decoration: none;
        color: #0366d6;
      }
      a:hover {
        text-decoration: underline;
      }
      form {
        margin-bottom: 16px;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      label {
        margin-right: 12px;
      }
      select,
      input[type="date"],
      input[type="text"] {
        padding: 2px 4px;
        font-size: 13px;
      }
      button {
        padding: 4px 12px;
        font-size: 13px;
        margin-left: 8px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 12px;
        font-size: 13px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 3px 4px;
      }
      th {
        background: #f5f5f5;
        white-space: nowrap;
      }
            td.right,
      th.right {
        text-align: right;
      }
      tbody tr:nth-child(odd) {
        background-color: #ffffff;
      }
      tbody tr:nth-child(even) {
        background-color: #f7f7ff;
      }
      .flash {
        color: darkred;
        margin-bottom: 10px;
      }
      .col-code {
        width: 8%;
      }
      .col-name {
        width: 30%;
      }
      .col-sys {
        width: 8%;
      }
      .col-price {
        width: 8%;
      }
      .col-amount {
        width: 10%;
      }
      .col-count {
        width: 10%;
      }
    </style>
  </head>
  <body>
    <h1>棚卸し入力</h1>

    <p>
      <a href="{{ url_for('index') }}">← メニューへ戻る</a> |
      <a href="{{ url_for('new_purchase') }}">仕入れ入力</a> |
      <a href="{{ url_for('purchase_report') }}">仕入れ照会</a>
    </p>

    {% with messages = get_flashed_messages() %} {% if messages %}
    <div class="flash">
      {% for msg in messages %}
      <div>{{ msg }}</div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %}

    <!-- 店舗＋棚卸日を指定して「表示」するフォーム（GET） -->
    <form method="get" action="{{ url_for('inventory_count') }}">
      <label>
        店舗：
        <select name="store_id">
          <option value="">--選択--</option>
          {% for s in stores %}
          <option
            value="{{ s['id'] }}"
            {% if selected_store_id and s['id'] == selected_store_id %}selected{% endif %}
          >
            {{ s['name'] }}
          </option>
          {% endfor %}
        </select>
      </label>

      <label>
        棚卸日：
        <input type="date" name="count_date" value="{{ count_date }}" />
      </label>
      
 <button type="submit" id="show-stock-btn" class="btn btn-secondary">
    在庫を表示
  </button>


{% if latest_date %}
  <span style="margin-left: 8px; font-size: 0.85rem; color: #666;">
    最終棚卸：{{ latest_date }}
    {% if latest_dates|length > 1 %}
      （過去：{{ latest_dates[1:]|join("・") }}）
    {% endif %}
  </span>
{% endif %}

</form>

    {% if selected_store_id and items %}
    <!-- 棚卸し入力フォーム（POST） -->
    <form method="post" action="{{ url_for('inventory_count') }}">
      <input type="hidden" name="store_id" value="{{ selected_store_id }}" />
      <input type="hidden" name="count_date" value="{{ count_date }}" />
      <input type="hidden" name="row_count" value="{{ items|length }}" />

      <p>※「システム在庫」が 0 より大きい品目のみ表示しています。</p>

{% for zone in zones %}
  {% set rows = grouped_items[zone] %}
  {% if rows %}
    <h2 style="margin-top:20px;">{{ zone }}</h2>

    <table>
      <thead>
        <tr>
          <th>品目コード</th>
          <th>品目名</th>
          <th class="right">システム在庫</th>
          <th class="right">単価</th>
          <th class="right">金額</th>
          <th class="right">棚卸数量</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          <td>{{ row.item_code }}</td>
          <td>{{ row.item_name }}</td>
          <td class="right">{{ row.system_qty }}</td>
          <td class="right">{{ "%.0f"|format(row.unit_price or 0) }}</td>
          <td class="right">{{ "%.0f"|format(row.stock_amount or 0) }}</td>
          <td class="right">
            <input type="text" name="count_qty_{{ loop.index }}"
              style="width:80px; text-align:right"
              value="{{ row.counted_qty if row.counted_qty != None }}"
            />
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
{% endfor %}

      <p style="margin-top: 10px">
        <button type="submit" id="submit-inventory-btn">棚卸しを登録</button>
      </p>
    </form>
    {% elif selected_store_id %}
    <p>該当する在庫がありません（システム在庫が 0 のみ）。</p>
    {% endif %}
 
<script>
document.addEventListener("DOMContentLoaded", function () {
  // 棚卸数量の入力欄（count_qty_〜）を行順に取得
  const qtyInputs = Array.from(
    document.querySelectorAll('input[name^="count_qty_"]')
  );

  const storeSelect = document.querySelector('select[name="store_id"]');
  const submitBtn = document.getElementById("submit-inventory-btn");

  // --------------------------
  // 初期フォーカス
  // --------------------------
  if (qtyInputs.length > 0) {
    // 在庫一覧が出ているとき → 1行目の棚卸数量へ
    qtyInputs[0].focus();
  } else if (storeSelect) {
    // まだ店舗未選択のとき → 店舗セレクトへ
    storeSelect.focus();
  }

  // --------------------------
  // 棚卸数量欄のキー操作
  // --------------------------
  qtyInputs.forEach((input, index) => {
    input.addEventListener("keydown", function (e) {
      const key = e.key;
      const keyCode = e.keyCode || e.which;

      const isEnter = (key === "Enter" || key === "Return" || keyCode === 13);
      const isArrowDown = (key === "ArrowDown" || keyCode === 40);
      const isArrowUp = (key === "ArrowUp" || keyCode === 38);

      const prev = qtyInputs[index - 1];
      const next = qtyInputs[index + 1];

      // Enter or ↓ → 次の行へ。最終行なら「棚卸しを登録」ボタンへ
      if (isEnter || isArrowDown) {
        e.preventDefault();

        if (next) {
          next.focus();
          next.select && next.select();
        } else if (submitBtn) {
          submitBtn.focus();
        }
      }

      // ↑ → 前の行へ
      if (isArrowUp) {
        e.preventDefault();
        if (prev) {
          prev.focus();
          prev.select && prev.select();
        }
      }
    });
  });
});
</script>
</body>
</html>