{% extends "base.html" %}

{% block title %}棚卸し入力{% endblock %}

{% block content %}
  

  <form method="get">
    <label>店舗：</label>
    <select name="store_id">
      <option value="">（店舗を選択）</option>
      {% for s in stores %}
        <option value="{{ s.id }}" {% if selected_store_id == s.id %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}
    </select>

    <label style="margin-left: 8px;">棚卸日：</label>
    <input type="date" name="count_date" value="{{ count_date }}">

    <button type="submit">表示</button>
  </form>

  {% if latest_dates %}
    <p style="margin-top: 4px; font-size: 12px; color: #666;">
      過去棚卸日：{{ latest_dates|join(" / ") }}  
      （最新：{{ latest_date }}）
    </p>
  {% endif %}

  {% if not selected_store_id %}
    <p style="margin-top: 12px;">店舗を選択すると棚卸し対象品目が表示されます。</p>
  {% endif %}

  {% if selected_store_id %}
    <form method="post" style="margin-top: 16px;">
      <input type="hidden" name="store_id" value="{{ selected_store_id }}">
      <input type="hidden" name="count_date" value="{{ count_date }}">
      <input type="hidden" name="row_count" value="{{ items|length }}">

      {% for zone in zones %}
        <h3>{{ zone }}</h3>

        <table border="1" cellpadding="4" cellspacing="0">
          <thead>
            <tr>
              <th>コード</th>
              <th>品目名</th>
              <th>システム在庫</th>
              <th>単価</th>
              <th>在庫金額</th>
              <th>棚卸数量</th>
            </tr>
          </thead>
          <tbody>
            {% for it in grouped_items.get(zone, []) %}
              <tr>
                <td>{{ it.item_code }}</td>
                <td>
                  {{ it.item_name }}
                  {% if it.is_internal %}<span style="font-size: 11px; color: #666;">（内製）</span>{% endif %}
                </td>
                <td style="text-align:right;">{{ it.system_qty }}</td>
                <td style="text-align:right;">{{ "%.2f"|format(it.unit_price) }}</td>
                <td style="text-align:right;">{{ "%.0f"|format(it.stock_amount) }}</td>
                <td style="text-align:right;">
                  <input
                    type="hidden"
                    name="item_id_{{ loop.index }}"
                    value="{{ it.item_id }}"
                  >
                  <input
                    type="hidden"
                    name="system_qty_{{ loop.index }}"
                    value="{{ it.system_qty }}"
                  >
                  <input
                    type="number"
                    name="count_qty_{{ loop.index }}"
                    value="{{ it.counted_qty if it.counted_qty is not none else '' }}"
                    style="width: 80px; text-align: right;"
                  >
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="6">対象品目がありません。</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endfor %}

      <p style="margin-top: 12px;">
        <button type="submit">棚卸し結果を登録する</button>
      </p>
    </form>
  {% endif %}
{% endblock %}
