{% extends "base.html" %}

{% block title %}{{ t("nav.inventory_count") }}{% endblock %}

{% block content %}

<div style="display:flex; justify-content:space-between; align-items:center;">
  <h2>{{ t("nav.inventory_count") }}</h2>

  <a href="{{ url_for('inventory_count_layout',
                      store_id=selected_store_id,
                      count_date=count_date) }}"
     class="btn"
     style="font-size:13px;">
    ▶ Physical Layout View
  </a>
</div>
<!-- Store + date selector (GET) -->
<form method="get" style="margin-bottom: 12px;">
  <label style="margin-right: 16px;">
    {{ t("inventory.count_date") }}：
    <input type="date" name="count_date" value="{{ count_date }}">
  </label>

  <label style="margin-right: 16px;">
    {{ t("form.store") }}：
    <select name="store_id" id="store_id">
      <option value="">{{ t("inventory.select_store") }}</option>
      {% for s in stores %}
        <option value="{{ s.id }}"
                {% if selected_store_id == s.id %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}
    </select>
  </label>

  <button type="submit">{{ t("form.show") }}</button>
</form>

{% if selected_store_id %}
  {% if latest_dates %}
    <p>
      {{ t("inventory.latest_count_dates") }}：
      {% for d in latest_dates %}
        <a href="{{ url_for('inventory_count',
                            store_id=selected_store_id,
                            count_date=d) }}">
          {{ d }}
        </a>{% if not loop.last %} / {% endif %}
      {% endfor %}
    </p>
  {% endif %}
{% endif %}

{% if not selected_store_id %}
  <p>{{ t("inventory.hint_select_store") }}</p>
{% endif %}

{% if items %}
  <!-- Inventory submit form (POST) -->
  <form method="post" id="inventory-form">
    <input type="hidden" name="store_id" value="{{ selected_store_id }}">
    <input type="hidden" name="count_date" value="{{ count_date }}">
    <input type="hidden" name="row_count" id="row_count" value="{{ items|length }}">

    {% set ns = namespace(row_index=0) %}

    {% for zone in zones %}
      {% set zone_items = grouped_items.get(zone, []) %}
      {% if zone_items %}
        <h3 style="margin-top:24px;">{{ zone }}</h3>

        <table class="monthly-table">
          <thead>
            <tr>
              <th>{{ t("inventory.item_code") }}</th>
              <th>{{ t("inventory.item_name") }}</th>
              <th class="num">{{ t("inventory.system_qty") }}</th>
              <th class="num">{{ t("inventory.unit_price") }}</th>
              <th class="num">{{ t("inventory.stock_amount") }}</th>
              <th class="num">{{ t("inventory.count_qty_input") }}</th>
            </tr>
          </thead>
          <tbody>
          {% for it in zone_items %}
            {% set ns.row_index = ns.row_index + 1 %}
            <tr>
              <td>{{ it.item_code }}</td>
              <td>{{ it.item_name }}</td>
              <td class="num">
                {{ "{:,}".format(it.system_qty) }}
                <input type="hidden"
                       name="item_id_{{ ns.row_index }}"
                       value="{{ it.item_id }}">
                <input type="hidden"
                       name="system_qty_{{ ns.row_index }}"
                       value="{{ it.system_qty }}">
              </td>
              <td class="num">
                {{ "{:,.2f}".format(it.unit_price) if it.unit_price else "" }}
              </td>
              <td class="num">
                {{ "{:,.0f}".format(it.stock_amount) if it.stock_amount else "" }}
              </td>
              <td class="num">
                <input
                  type="text"
                  name="count_qty_{{ ns.row_index }}"
                  value="{{ it.counted_qty if it.counted_qty is not none else '' }}"
                  class="num count-input"
                  data-row="{{ ns.row_index }}"
                  data-col="0"
                  style="width:80px; text-align:right;"
                >
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% endif %}
    {% endfor %}

    <div style="margin-top:16px;">
      <button type="submit">{{ t("inventory.save") }}</button>
    </div>
  </form>
{% endif %}

{% endblock %}

{% block body_extra %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const storeSelect = document.getElementById("store_id");
  const inputs = Array.from(document.querySelectorAll(".count-input"));

  // If no items yet, focus store selector
  if (inputs.length === 0) {
    if (storeSelect) storeSelect.focus();
    return;
  }

  // --- Navigation for count inputs ---
  function findInput(row, col) {
    return inputs.find(el =>
      el.getAttribute("data-row") == row &&
      el.getAttribute("data-col") == col
    );
  }

  inputs.forEach(input => {
    input.addEventListener("keydown", function (e) {
      const row = parseInt(this.getAttribute("data-row"), 10);
      const col = parseInt(this.getAttribute("data-col"), 10);

      if (e.key === "Enter") {
        e.preventDefault();
        const currentIndex = inputs.indexOf(this);
        const next = inputs[currentIndex + 1];
        if (next) next.focus();
        return;
      }

      if (e.key === "ArrowDown") {
        e.preventDefault();
        const next = findInput(row + 1, col);
        if (next) next.focus();
        return;
      }

      if (e.key === "ArrowUp") {
        e.preventDefault();
        const prev = findInput(row - 1, col);
        if (prev) prev.focus();
        return;
      }

      if (e.key === "ArrowRight") {
        e.preventDefault();
        const currentIndex = inputs.indexOf(this);
        const next = inputs[currentIndex + 1];
        if (next) next.focus();
        return;
      }

      if (e.key === "ArrowLeft") {
        e.preventDefault();
        const currentIndex = inputs.indexOf(this);
        const prev = inputs[currentIndex - 1];
        if (prev) prev.focus();
        return;
      }
    });
  });

  // Items are shown → focus first input
  inputs[0].focus();
});
</script>
{% endblock %}
