{% extends "base.html" %}

{% block title %}仕入れ（納品書）入力{% endblock %}

{% block content %}
  <h2>仕入れ（納品書）入力</h2>

  <!-- 店舗選択フォーム -->
  <form method="get" action="{{ url_for('new_purchase') }}">
    <label>店舗：</label>
    <select name="store_id" onchange="this.form.submit()">
      <option value="">（全店舗）</option>
      {% for s in stores %}
        <option value="{{ s.id }}" {% if selected_store_id == s.id %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}
    </select>
    <noscript><button type="submit">切替</button></noscript>
  </form>

  <hr>

  <!-- 新規登録フォーム（最大5行） -->
  <form method="post" action="{{ url_for('new_purchase', store_id=selected_store_id) }}">
    <table border="1" cellpadding="4" cellspacing="0">
      <thead>
        <tr>
          <th>行</th>
          <th>納品日</th>
          <th>仕入先</th>
          <th>品目</th>
          <th>数量</th>
          <th>単価</th>
        </tr>
      </thead>
      <tbody>
        {% for i in range(1, 6) %}
        <tr>
          <td>{{ i }}</td>
          <td>
            <input type="date" name="detail_date_{{ i }}">
          </td>
          <td>
            <select name="supplier_id_{{ i }}">
              <option value="">（選択してください）</option>
              {% for s in suppliers %}
                <option value="{{ s.id }}">{{ s.name }}</option>
              {% endfor %}
            </select>
          </td>
          <td>
            <!-- JS で supplier 選択時に品目プルダウンを埋める前提 -->
            <select name="item_id_{{ i }}" class="item-select" data-row="{{ i }}">
              <option value="">（仕入先を選択してください）</option>
            </select>
          </td>
          <td>
            <input type="text" name="quantity_{{ i }}" size="6">
          </td>
          <td>
            <input type="text" name="unit_price_{{ i }}" size="8">
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <p style="margin-top: 12px;">
      <button type="submit">登録する</button>
    </p>
  </form>

  <hr>

  <!-- 検索フォーム（直近50件） -->
  <h3>直近取引一覧（最新50件）</h3>

  <form method="get" action="{{ url_for('new_purchase') }}">
    <input type="hidden" name="store_id" value="{{ selected_store_id or '' }}">
    <div>
      <label>期間：</label>
      <input type="date" name="from_date" value="{{ from_date or '' }}"> 〜
      <input type="date" name="to_date" value="{{ to_date or '' }}">
    </div>
    <div style="margin-top: 4px;">
      <label>キーワード：</label>
      <input type="text" name="q" value="{{ search_q or '' }}" size="20">
    </div>
    <div style="margin-top: 8px;">
      <button type="submit">検索</button>
      <a href="{{ url_for('new_purchase', store_id=selected_store_id, clear=1) }}">
        条件クリア
      </a>
    </div>
  </form>

  <table border="1" cellpadding="4" cellspacing="0" style="margin-top: 12px;">
    <thead>
      <tr>
        <th>ID</th>
        <th>納品日</th>
        <th>仕入先</th>
        <th>品目</th>
        <th>数量</th>
        <th>単価</th>
        <th>金額</th>
        <th>編集</th>
      </tr>
    </thead>
    <tbody>
      {% for p in purchases %}
        <tr>
          <td>{{ p.id }}</td>
          <td>{{ p.delivery_date }}</td>
          <td>{{ p.supplier_name }}</td>
          <td>{{ p.item_name }}</td>
          <td style="text-align:right;">{{ "{:,}".format(p.quantity) }}</td>
          <td style="text-align:right;">{{ "{:,}".format(p.unit_price) }}</td>
          <td style="text-align:right;">{{ "{:,}".format(p.amount) }}</td>
          <td>
            <a href="{{ url_for('edit_purchase', purchase_id=p.id) }}">編集</a>
          </td>
        </tr>
      {% else %}
        <tr>
          <td colspan="8">該当する取引がありません。</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

{% endblock %}

{% block body_extra %}
<script>
  // 仕入先ごと品目一覧 API を使ってセレクトを埋める簡易JS
  document.addEventListener("change", function (e) {
    const target = e.target;
    if (target.name && target.name.startsWith("supplier_id_")) {
      const row = target.name.split("_").pop();
      const supplierId = target.value;
      const itemSelect = document.querySelector('select[name="item_id_' + row + '"]');
      if (!itemSelect) return;

      itemSelect.innerHTML = '<option value="">読み込み中...</option>';

      if (!supplierId) {
        itemSelect.innerHTML = '<option value="">（仕入先を選択してください）</option>';
        return;
      }

      fetch("/api/items/by_supplier/" + supplierId)
        .then(res => res.json())
        .then(data => {
          let options = '<option value="">（選択してください）</option>';
          data.forEach(function (item) {
            const unit = item.unit ? ' / ' + item.unit : '';
            options += '<option value="' + item.id + '">' +
                        item.code + ' ' + item.name + unit +
                       '</option>';
          });
          itemSelect.innerHTML = options;
        })
        .catch(() => {
          itemSelect.innerHTML = '<option value="">読み込み失敗</option>';
        });
    }
  });
</script>
{% endblock %}
