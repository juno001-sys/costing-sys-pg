{% block body_extra %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const supplierSelect = document.getElementById("supplier_id");
  const tbody = document.getElementById("item-rows");
  const rowCountInput = document.getElementById("row_count");
  const addBtn = document.getElementById("add-row-btn");

  /* ------------------------------
     仕入先変更 → 品目リスト再取得
     （option に data-unit を付ける）
  ------------------------------ */
  function loadItems(supplierId) {
    const selects = tbody.querySelectorAll(".item-select");

    // 仕入先未選択なら空に
    if (!supplierId) {
      selects.forEach((sel) => {
        sel.innerHTML = '<option value="">（品目を選択）</option>';
      });
      return;
    }

    fetch(`/api/items/by_supplier/${supplierId}`)
      .then((resp) => resp.json())
      .then((data) => {
        selects.forEach((sel) => {
          const current = sel.value || "";
          sel.innerHTML = '<option value="">（品目を選択）</option>';

          data.forEach((item) => {
            const opt = document.createElement("option");
            opt.value = item.id;
            opt.textContent = `${item.code || ""} ${item.name}`;
            if (item.unit != null) {
              opt.setAttribute("data-unit", item.unit);
            }
            if (current && String(current) === String(item.id)) {
              opt.selected = true;
            }
            sel.appendChild(opt);
          });
        });
      });
  }

  // 初期：仕入先が選択済みなら品目ロード
  if (supplierSelect.value) {
    loadItems(supplierSelect.value);
  }

  supplierSelect.addEventListener("change", () => {
    loadItems(supplierSelect.value);
  });

  /* -----------------------------------
     数量 × 単価 → 金額 自動計算
  ----------------------------------- */
  function parseIntSafe(v) {
    if (!v) return 0;
    return parseInt(String(v).replace(/,/g, ""), 10) || 0;
  }

  function recalcRow(tr) {
    const qtyInput = tr.querySelector(".qty-input");
    const priceInput = tr.querySelector(".price-input");
    const amountInput = tr.querySelector(".amount-display");
    if (!qtyInput || !priceInput || !amountInput) return;

    const q = parseIntSafe(qtyInput.value);
    const p = parseIntSafe(priceInput.value);
    const a = q * p;
    amountInput.value = a ? a.toLocaleString("ja-JP") : "";
  }

  function recalcAll() {
    tbody.querySelectorAll("tr").forEach(recalcRow);

    const totalCell = document.getElementById("total_amount_display");
    if (totalCell) {
      let total = 0;
      tbody.querySelectorAll(".amount-display").forEach((inp) => {
        total += parseIntSafe(inp.value);
      });
      totalCell.textContent = total ? total.toLocaleString("ja-JP") : "";
    }
  }

  // 数量/単価入力時にその行＆合計を再計算
  tbody.addEventListener("input", (e) => {
    if (e.target.matches(".qty-input") || e.target.matches(".price-input")) {
      const tr = e.target.closest("tr");
      if (tr) {
        recalcRow(tr);
        recalcAll();
      }
    }
  });

  /* -----------------------------------
     品目選択 → unit を数量にセット
  ----------------------------------- */
  tbody.addEventListener("change", (e) => {
    if (!e.target.matches(".item-select")) return;

    const sel = e.target;
    const opt = sel.options[sel.selectedIndex];
    const unit = opt ? opt.getAttribute("data-unit") : null;
    const tr = sel.closest("tr");
    const qtyInput = tr ? tr.querySelector(".qty-input") : null;

    // 数量が未入力のときだけ、マスタの unit を入れる
    if (qtyInput && unit && !qtyInput.value) {
      qtyInput.value = unit;
    }
    recalcRow(tr);
    recalcAll();
  });

  /* -----------------------------------
     行番号・data-row 再採番
  ----------------------------------- */
  function renumberRows() {
    const rows = tbody.querySelectorAll("tr");
    let n = 1;
    rows.forEach((tr) => {
      const noCell = tr.querySelector(".row-no");
      if (noCell) noCell.textContent = n;

      // nav-input に data-row を振り直し
      tr.querySelectorAll(".nav-input").forEach((el) => {
        el.dataset.row = String(n);
      });

      n++;
    });
    rowCountInput.value = String(rows.length);
  }

  /* ------------------------------
     ＋行を追加（最大 30 行）
  ------------------------------ */
  addBtn.addEventListener("click", () => {
    const currentRows = tbody.querySelectorAll("tr").length;
    if (currentRows >= 30) {
      alert("これ以上追加できません（上限30行）");
      return;
    }
    const newIndex = currentRows + 1;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="row-no"></td>
      <td>
        <select name="item_id_${newIndex}"
                class="item-select nav-input"
                data-col="0">
          <option value="">（品目を選択）</option>
        </select>
      </td>
      <td>
        <input type="text" name="quantity_${newIndex}"
               class="num qty-input nav-input"
               data-col="1"
               style="width:80px;">
      </td>
      <td>
        <input type="text" name="unit_price_${newIndex}"
               class="num price-input nav-input"
               data-col="2"
               style="width:100px;">
      </td>
      <td>
        <input type="text" name="amount_display_${newIndex}"
               class="amount-display"
               readonly tabindex="-1">
      </td>
      <td>
        <button type="button" class="delete-row">✖</button>
      </td>
    `;
    tbody.appendChild(tr);

    // 追加行の品目プルダウンにも候補をセット
    if (supplierSelect.value) {
      loadItems(supplierSelect.value);
    }

    renumberRows();
    recalcAll();
  });

  /* -----------------------------------
     行削除 ＆ No./data-row 再採番
  ----------------------------------- */
  tbody.addEventListener("click", function(e) {
    if (e.target.classList.contains("delete-row")) {
      const tr = e.target.closest("tr");
      if (tr) {
        tr.remove();
        renumberRows();
        recalcAll();
      }
    }
  });

  /* -----------------------------------
     テンキー移動（↑↓）復活！
     数量・単価欄だけを対象にする
  ----------------------------------- */
  tbody.addEventListener("keydown", function(e) {
    if (e.key !== "ArrowDown" && e.key !== "ArrowUp") return;

    const el = e.target;
    // 対象は数量・単価だけ（品目プルダウンやヘッダーは無視）
    if (!el.classList.contains("qty-input") &&
        !el.classList.contains("price-input")) {
      return;
    }

    const row = parseInt(el.dataset.row || "0", 10);
    const col = el.dataset.col;
    if (!row || col === undefined) return;

    const nextRow = (e.key === "ArrowDown") ? row + 1 : row - 1;
    if (nextRow < 1) return;

    const next = tbody.querySelector(
      `.nav-input[data-row="${nextRow}"][data-col="${col}"]`
    );
    if (next) {
      next.focus();
      e.preventDefault();
    }
  });

  // 初期化：行番号と data-row をセットしてから計算
  renumberRows();
  recalcAll();
});
</script>
{% endblock %}
