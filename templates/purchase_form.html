{% extends "base.html" %}

{% block title %}仕入れ（納品書）入力{% endblock %}

{% block head_extra %}
<style>
  /* 金額欄は「表示専用」っぽく */
  .amount-display {
    border: none;
    background: transparent;
    text-align: right;
    width: 120px;
    padding-right: 4px;
  }
  .amount-display:focus {
    outline: none;
  }
  /* 合計セル */
  #total-amount-cell {
    font-weight: bold;
  }
 
.item-combo{ position:relative; }
.item-search{ width:210px; }
.item-suggest{
  position:absolute; z-index:1000;
  top:100%; left:0; right:0;
  max-height:260px; overflow:auto;
  border:1px solid #ccc; background:#fff;
  box-shadow:0 6px 16px rgba(0,0,0,.12);
}
.item-suggest .opt{
  padding:6px 8px; cursor:pointer;
  display:flex; gap:8px;
}
.item-suggest .opt.active{ background:#eef; }
.item-suggest .code{ min-width:56px; font-weight:600; }
.item-suggest .meta{ margin-left:auto; opacity:.65; font-size:12px; }

</style>
{% endblock %}

{% block content %}

<h2>仕入れ（納品書）入力</h2>

<form method="post" id="purchase-form">

  <!-- 伝票ヘッダー -->
    <div style="margin-bottom: 12px;">
  <label style="margin-right: 16px;">
    <span class="field-label">店舗：</span>
    <select name="store_id" onchange="this.form.submit()">
      <option value="">（店舗を選択）</option>
      {% for st in stores %}
        <option value="{{ st.id }}"
          {% if selected_store_id == st.id %}selected{% endif %}>
          {{ st.name }}
        </option>
      {% endfor %}
    </select>
  </label>
</div>
  <div style="margin-bottom: 12px;">
    <label style="margin-right: 16px;">
      <span class="field-label">仕入先：</span>
      <select name="supplier_id" id="supplier_id" required>
        <option value="">（仕入先を選択）</option>
        {% for sp in suppliers %}
          <option value="{{ sp.id }}">{{ sp.name }}</option>
        {% endfor %}
      </select>
    </label>

    <label>
      <span class="field-label">納品日：</span>
      <input type="date" name="delivery_date" required />
    </label>
  </div>
  <!-- 明細テーブル -->
  <input type="hidden" id="row_count" name="row_count" value="8">

  <table id="items-table" class="monthly-table">
    <thead>
      <tr>
        <th style="width:40px;">No.</th>
        <th style="width:220px;">品目</th>
        <th class="num" style="width:90px;">数量</th>
        <th class="num" style="width:110px;">単価</th>
        <th class="num" style="width:120px;">金額</th>
        <th style="width:50px;">削除</th>
      </tr>
    </thead>

    <tbody id="item-rows">
      {% for i in range(1, 9) %}
      <tr>
        <td class="row-no">{{ i }}</td>
      
      <td>
        <!-- 行ごとの品目検索 -->
        <input type="text"
               class="item-search"
               placeholder="品名・コード検索"
               autocomplete="off"
               style="width:210px; margin-bottom:2px;">
      
        <!-- 実際に送信される品目選択 -->
        <div class="item-combo">
          <input type="text"
                 class="item-search nav-input"
                 data-col="0"
                 placeholder="コード/品名で検索"
                 autocomplete="off">
          <input type="hidden" name="item_id_{{ i }}" class="item-id-hidden">
          <div class="item-suggest" hidden></div>
        </div>    
      </td>
        <td>
          <input type="text"
                 name="quantity_{{ i }}"
                 class="num qty-input nav-input"
                 data-col="1"
                 style="width:80px;">
        </td>

        <td>
          <input type="text"
                 name="unit_price_{{ i }}"
                 class="num price-input nav-input"
                 data-col="2"
                 style="width:100px;">
        </td>

        <td>
          <input type="text"
                 name="amount_display_{{ i }}"
                 class="amount-display"
                 readonly
                 tabindex="-1">
        </td>

        <td>
          <button type="button" class="delete-row">✖</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>

    <!-- 合計行 -->
        <tfoot>
      <tr class="total-row">
        <td colspan="4" class="num">合計</td>
        <td class="num" id="total_amount_display"></td>
      </tr>
    </tfoot>
  </table>

  <button type="button" id="add-row-btn" style="margin-top:12px;">
    ＋ 行を追加
  </button>

  <div style="margin-top:16px;">
    <button type="submit">登録</button>
  </div>

</form>

<hr style="margin:32px 0;">


<!-- ============================
     直近50件（既存）
============================ -->
<h2>直近 50 件</h2>

<form method="get" style="margin-bottom: 12px;">
  <label style="margin-right: 12px;">
    店舗：
    <select name="store_id">
      <option value="">（全店舗）</option>
      {% for s in stores %}
        <option value="{{ s.id }}"
                {% if selected_store_id == s.id %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}
    </select>
  </label>

  <label style="margin-right: 12px;">
    期間：
    <input type="date" name="from_date" value="{{ from_date or '' }}">
    〜
    <input type="date" name="to_date" value="{{ to_date or '' }}">
  </label>

  <label style="margin-right: 12px;">
    キーワード：
    <input type="text" name="q" value="{{ search_q or '' }}">
  </label>

  <button type="submit">検索</button>
  <a href="{{ url_for('new_purchase', clear='1', store_id=selected_store_id) }}">
    条件クリア
  </a>
</form>

<table class="monthly-table">
  <thead>
    <tr>
      <th>納品日</th>
      <th>仕入先</th>
      <th>品目</th>
      <th class="num">数量</th>
      <th class="num">単価</th>
      <th class="num">金額</th>
      <th>編集</th>
    </tr>
  </thead>
  <tbody>
    {% for p in purchases %}
    <tr>
      <td>{{ p.delivery_date }}</td>
      <td>{{ p.supplier_name }}</td>
      <td>{{ p.item_name }}</td>
      <td class="num">{{ "{:,}".format(p.quantity) }}</td>
      <td class="num">{{ "{:,}".format(p.unit_price) }}</td>
      <td class="num">{{ "{:,}".format(p.amount) }}</td>
      <td><a href="{{ url_for('edit_purchase', purchase_id=p.id) }}">編集</a></td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}


{% block body_extra %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const supplierSelect = document.getElementById("supplier_id");
  const tbody          = document.getElementById("item-rows");
  const rowCountInput  = document.getElementById("row_count");
  const addBtn         = document.getElementById("add-row-btn");

  // 仕入先ごとの全品目リスト（1回APIで取って、検索時に使い回す）
  let baseItems = [];

  function parseIntSafe(v) {
    if (!v) return 0;
    return parseInt(String(v).replace(/,/g, ""), 10) || 0;
  }

  /* -----------------------------------
     品目プルダウンのロード（仕入先単位）
  ----------------------------------- */
  function loadItems(supplierId) {
    const selects  = tbody.querySelectorAll(".item-select");
    const searches = tbody.querySelectorAll(".item-search");

    if (!supplierId) {
      baseItems = [];
      selects.forEach(sel => {
        sel.innerHTML = '<option value="">（品目を選択）</option>';
      });
      searches.forEach(inp => { inp.value = ""; });
      return Promise.resolve();
    }

    return fetch(`/api/items/by_supplier/${supplierId}`)
      .then(resp => resp.json())
      .then(data => {
        baseItems = Array.isArray(data) ? data : [];

        // 仕入先が変わったら検索キーワードはクリア
        searches.forEach(inp => { inp.value = ""; });

        // 各行の品目セレクトをフルリストで再構築
        selects.forEach(sel => {
          const current = sel.value || "";
          sel.innerHTML = '<option value="">（品目を選択）</option>';

          baseItems.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item.id;
            opt.textContent = `${item.code || ""} ${item.name}`;
            if (item.unit != null) opt.setAttribute("data-unit", item.unit);
            if (current && String(current) === String(item.id)) opt.selected = true;
            sel.appendChild(opt);
          });
        });
      });
  }

  // 初期ロード & 仕入先変更時
  if (supplierSelect) {
    if (supplierSelect.value) loadItems(supplierSelect.value);
    supplierSelect.addEventListener("change", function () {
      loadItems(this.value);
    });
  }

  /* -----------------------------------
     金額計算系
  ----------------------------------- */
  function recalcRow(tr) {
    const qtyInput    = tr.querySelector(".qty-input");
    const priceInput  = tr.querySelector(".price-input");
    const amountInput = tr.querySelector(".amount-display");
    if (!qtyInput || !priceInput || !amountInput) return;

    const q = parseIntSafe(qtyInput.value);
    const p = parseIntSafe(priceInput.value);
    const a = q * p;
    amountInput.value = a ? a.toLocaleString("ja-JP") : "";
  }

  function recalcAll() {
    tbody.querySelectorAll("tr").forEach(recalcRow);

    const totalCell = document.getElementById("total_amount_display");
    if (totalCell) {
      let total = 0;
      tbody.querySelectorAll(".amount-display").forEach(inp => {
        total += parseIntSafe(inp.value);
      });
      totalCell.textContent = total ? total.toLocaleString("ja-JP") : "";
    }
  }

  /* -----------------------------------
     行番号 & row_count 再採番
  ----------------------------------- */
  function renumberRows() {
    const rows = tbody.querySelectorAll("tr");
    let n = 1;
    rows.forEach(tr => {
      const noCell = tr.querySelector(".row-no");
      if (noCell) noCell.textContent = n;
      n++;
    });
    if (rowCountInput) rowCountInput.value = String(rows.length);
  }

  /* -----------------------------------
     品目選択 → unit を数量にセット
  ----------------------------------- */
  tbody.addEventListener("change", function (e) {
    if (!e.target.matches(".item-select")) return;

    const sel      = e.target;
    const opt      = sel.options[sel.selectedIndex];
    const unit     = opt ? opt.getAttribute("data-unit") : null;
    const tr       = sel.closest("tr");
    const qtyInput = tr ? tr.querySelector(".qty-input") : null;

    if (qtyInput && unit && !qtyInput.value) qtyInput.value = unit;

    if (tr) {
      recalcRow(tr);
      recalcAll();
    }
  });

  /* -----------------------------------
     行ごとの品目検索（per-row）
     - .item-search 入力 → その行の select option を絞り込み
  ----------------------------------- */
  function rebuildRowOptions(tr, query) {
    if (!baseItems || baseItems.length === 0) return;
    const sel = tr.querySelector(".item-select");
    if (!sel) return;

    const current = sel.value || "";
    const q = (query || "").toLowerCase();

    sel.innerHTML = '<option value="">（品目を選択）</option>';

    baseItems.forEach(item => {
      const text = `${item.code || ""} ${item.name || ""}`.trim();
      if (!q || text.toLowerCase().includes(q)) {
        const opt = document.createElement("option");
        opt.value = item.id;
        opt.textContent = text;
        if (item.unit != null) opt.setAttribute("data-unit", item.unit);
        if (current && String(current) === String(item.id)) opt.selected = true;
        sel.appendChild(opt);
      }
    });
  }

  /* -----------------------------------
     tbody の input イベントまとめて処理
     - 数量 / 単価入力 → 金額再計算
     - 品目検索 → option 絞り込み
  ----------------------------------- */
  tbody.addEventListener("input", function (e) {
    const target = e.target;

    // 数量 / 単価 → 行と合計を再計算
    if (target.matches(".qty-input") || target.matches(".price-input")) {
      const tr = target.closest("tr");
      if (tr) {
        recalcRow(tr);
        recalcAll();
      }
      return;
    }

    // 行ごとの品目検索
    if (target.classList.contains("item-search")) {
      const tr = target.closest("tr");
      if (tr) rebuildRowOptions(tr, target.value);
      return;
    }
  });

  /* ------------------------------
     ＋行を追加（最大30行）
  ------------------------------ */
  if (addBtn) {
    addBtn.addEventListener("click", function () {
      const currentRows = tbody.querySelectorAll("tr").length;
      if (currentRows >= 30) {
        alert("これ以上追加できません（上限30行）");
        return;
      }
      const newIndex = currentRows + 1;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="row-no"></td>
        <td>
          <input type="text"
                 class="item-search"
                 placeholder="品名・コード検索"
                 autocomplete="off"
                 style="width:210px; margin-bottom:2px;">
          <select name="item_id_${newIndex}"
                  class="item-select nav-input"
                  data-col="0">
            <option value="">（品目を選択）</option>
          </select>
        </td>
        <td>
          <input type="text" name="quantity_${newIndex}"
                 class="num qty-input nav-input"
                 data-col="1"
                 style="width:80px;">
        </td>
        <td>
          <input type="text" name="unit_price_${newIndex}"
                 class="num price-input nav-input"
                 data-col="2"
                 style="width:100px;">
        </td>
        <td>
          <input type="text" name="amount_display_${newIndex}"
                 class="amount-display"
                 readonly tabindex="-1">
        </td>
        <td>
          <button type="button" class="delete-row">✖</button>
        </td>
      `;
      tbody.appendChild(tr);

      // すでに baseItems があれば、新しい行のセレクトにも候補をセット
      if (baseItems.length > 0) {
        const sel = tr.querySelector(".item-select");
        sel.innerHTML = '<option value="">（品目を選択）</option>';
        baseItems.forEach(item => {
          const opt = document.createElement("option");
          opt.value = item.id;
          opt.textContent = `${item.code || ""} ${item.name}`;
          if (item.unit != null) opt.setAttribute("data-unit", item.unit);
          sel.appendChild(opt);
        });
      }

      renumberRows();
      recalcAll();
    });
  }

  /* -----------------------------------
     行削除 ＆ 再採番
  ----------------------------------- */
  tbody.addEventListener("click", function (e) {
    if (e.target.classList.contains("delete-row")) {
      const tr = e.target.closest("tr");
      if (tr) {
        tr.remove();
        renumberRows();
        recalcAll();
      }
    }
  });

  /* ======================================================
     Excel-like Navigation（矢印＋Enter）
     nav-input（品目select / 数量 / 単価）だけを対象
     ※ input は矢印でカーソル移動があるので縦移動だけ奪う
  ====================================================== */
  function getNavCells() {
    const rows = Array.from(tbody.querySelectorAll("tr"));
    return rows.map(tr => Array.from(tr.querySelectorAll(".nav-input")));
  }

  tbody.addEventListener("keydown", function (e) {
    const el = e.target;
    if (!el.classList.contains("nav-input")) return;

    const nav = getNavCells();

    let rowIndex = -1;
    let colIndex = -1;
    for (let r = 0; r < nav.length; r++) {
      for (let c = 0; c < nav[r].length; c++) {
        if (nav[r][c] === el) {
          rowIndex = r;
          colIndex = c;
          break;
        }
      }
      if (rowIndex >= 0) break;
    }
    if (rowIndex < 0 || colIndex < 0) return;

    const isSelect = (el.tagName === "SELECT");
    const isInput  = (el.tagName === "INPUT" || el.tagName === "TEXTAREA");

    // → right（入力欄はキャレット移動があるので、基本は Enter を使う想定）
    if (e.key === "ArrowRight") {
      if (isSelect && nav[rowIndex][colIndex + 1]) {
        nav[rowIndex][colIndex + 1].focus();
        e.preventDefault();
      }
      return;
    }

    // ← left（同上）
    if (e.key === "ArrowLeft") {
      if (isSelect && colIndex > 0 && nav[rowIndex][colIndex - 1]) {
        nav[rowIndex][colIndex - 1].focus();
        e.preventDefault();
      }
      return;
    }

    // ↓ down（input は縦移動、select はネイティブ優先）
    if (!isSelect && e.key === "ArrowDown") {
      if (nav[rowIndex + 1] && nav[rowIndex + 1][colIndex]) {
        nav[rowIndex + 1][colIndex].focus();
        e.preventDefault();
      }
      return;
    }

    // ↑ up（inputのみ）
    if (!isSelect && e.key === "ArrowUp") {
      if (rowIndex > 0 && nav[rowIndex - 1][colIndex]) {
        nav[rowIndex - 1][colIndex].focus();
        e.preventDefault();
      }
      return;
    }

    // Enter キーで右隣へ、行末なら次行の先頭へ
    if (e.key === "Enter") {
      // 入力欄で Enter → 改行を入れないため
      e.preventDefault();

      if (nav[rowIndex][colIndex + 1]) {
        nav[rowIndex][colIndex + 1].focus();
        return;
      }
      if (nav[rowIndex + 1] && nav[rowIndex + 1][0]) {
        nav[rowIndex + 1][0].focus();
      }
    }
  });

  // 初期再計算
  renumberRows();
  recalcAll();
});
</script>{% endblock %}
