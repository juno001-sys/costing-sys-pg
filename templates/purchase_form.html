{% extends "base.html" %}

{% block title %}仕入れ（納品書）入力{% endblock %}

{% block head_extra %}
<style>
  /* 金額欄は「表示専用」っぽく */
  .amount-display {
    border: none;
    background: transparent;
    text-align: right;
    width: 120px;
    padding-right: 4px;
  }
  .amount-display:focus {
    outline: none;
  }
  /* 合計セル */
  #total-amount-cell {
    font-weight: bold;
  }
 
.item-combo{ position:relative; }
.item-search{ width:210px; }
.item-suggest{
  position:absolute; z-index:1000;
  top:100%; left:0; right:0;
  max-height:260px; overflow:auto;
  border:1px solid #ccc; background:#fff;
  box-shadow:0 6px 16px rgba(0,0,0,.12);
}
.item-suggest .opt{
  padding:6px 8px; cursor:pointer;
  display:flex; gap:8px;
}
.item-suggest .opt.active{ background:#eef; }
.item-suggest .code{ min-width:56px; font-weight:600; }
.item-suggest .meta{ margin-left:auto; opacity:.65; font-size:12px; }
.item-cell {
  position: relative;
}

.item-suggestions {
  position: absolute;
  z-index: 1000;
  background: #fff;
  border: 1px solid #ccc;
  width: 100%;
  max-height: 220px;
  overflow-y: auto;
  display: none;
}

.item-suggestions div {
  padding: 6px 8px;
  cursor: pointer;
}

.item-suggestions div:hover,
.item-suggestions .active {
  background: #e6f0ff;
}
</style>
{% endblock %}

{% block content %}

<h2>仕入れ（納品書）入力</h2>

<form method="post" id="purchase-form">

  <!-- 伝票ヘッダー -->
    <div style="margin-bottom: 12px;">
  <label style="margin-right: 16px;">
    <span class="field-label">店舗：</span>
    <select name="store_id" onchange="this.form.submit()">
      <option value="">（店舗を選択）</option>
      {% for st in stores %}
        <option value="{{ st.id }}"
          {% if selected_store_id == st.id %}selected{% endif %}>
          {{ st.name }}
        </option>
      {% endfor %}
    </select>
  </label>
</div>
  <div style="margin-bottom: 12px;">
    <label style="margin-right: 16px;">
      <span class="field-label">仕入先：</span>
      <select name="supplier_id" id="supplier_id" required>
        <option value="">（仕入先を選択）</option>
        {% for sp in suppliers %}
          <option value="{{ sp.id }}">{{ sp.name }}</option>
        {% endfor %}
      </select>
    </label>

    <label>
      <span class="field-label">納品日：</span>
      <input type="date" name="delivery_date" required />
    </label>
  </div>
  <!-- 明細テーブル -->
  <input type="hidden" id="row_count" name="row_count" value="8">

  <table id="items-table" class="monthly-table">
    <thead>
      <tr>
        <th style="width:40px;">No.</th>
        <th style="width:220px;">品目</th>
        <th class="num" style="width:90px;">数量</th>
        <th class="num" style="width:110px;">単価</th>
        <th class="num" style="width:120px;">金額</th>
        <th style="width:50px;">削除</th>
      </tr>
    </thead>

    <tbody id="item-rows">
      {% for i in range(1, 9) %}
      <tr>
        <td class="row-no">{{ i }}</td>
      
      <td class="item-cell">
  <!-- Single input: search + select -->
  <input type="text"
         class="item-autocomplete nav-input"
         name="item_label_{{ i }}"
         placeholder="品名・コード検索"
         autocomplete="off"
         style="width:210px;">

  <!-- 실제로 서버에 보내는 값 -->
  <input type="hidden"
         name="item_id_{{ i }}"
         class="item-id">

  <!-- suggestion dropdown -->
  <div class="item-suggestions"></div>
</td>

<td>
  <input type="text"
         name="quantity_{{ i }}"
         class="num qty-input nav-input"
         data-col="1"
         style="width:80px;">
</td>
        <td>
          <input type="text"
                 name="unit_price_{{ i }}"
                 class="num price-input nav-input"
                 data-col="2"
                 style="width:100px;">
        </td>

        <td>
          <input type="text"
                 name="amount_display_{{ i }}"
                 class="amount-display"
                 readonly
                 tabindex="-1">
        </td>

        <td>
          <button type="button" class="delete-row">✖</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>

    <!-- 合計行 -->
        <tfoot>
      <tr class="total-row">
        <td colspan="4" class="num">合計</td>
        <td class="num" id="total_amount_display"></td>
      </tr>
    </tfoot>
  </table>

  <button type="button" id="add-row-btn" style="margin-top:12px;">
    ＋ 行を追加
  </button>

  <div style="margin-top:16px;">
    <button type="submit">登録</button>
  </div>

</form>

<hr style="margin:32px 0;">


<!-- ============================
     直近50件（既存）
============================ -->
<h2>直近 50 件</h2>

<form method="get" style="margin-bottom: 12px;">
  <label style="margin-right: 12px;">
    店舗：
    <select name="store_id">
      <option value="">（全店舗）</option>
      {% for s in stores %}
        <option value="{{ s.id }}"
                {% if selected_store_id == s.id %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}
    </select>
  </label>

  <label style="margin-right: 12px;">
    期間：
    <input type="date" name="from_date" value="{{ from_date or '' }}">
    〜
    <input type="date" name="to_date" value="{{ to_date or '' }}">
  </label>

  <label style="margin-right: 12px;">
    キーワード：
    <input type="text" name="q" value="{{ search_q or '' }}">
  </label>

  <button type="submit">検索</button>
  <a href="{{ url_for('new_purchase', clear='1', store_id=selected_store_id) }}">
    条件クリア
  </a>
</form>

<table class="monthly-table">
  <thead>
    <tr>
      <th>納品日</th>
      <th>仕入先</th>
      <th>品目</th>
      <th class="num">数量</th>
      <th class="num">単価</th>
      <th class="num">金額</th>
      <th>編集</th>
    </tr>
  </thead>
  <tbody>
    {% for p in purchases %}
    <tr>
      <td>{{ p.delivery_date }}</td>
      <td>{{ p.supplier_name }}</td>
      <td>{{ p.item_name }}</td>
      <td class="num">{{ "{:,}".format(p.quantity) }}</td>
      <td class="num">{{ "{:,}".format(p.unit_price) }}</td>
      <td class="num">{{ "{:,}".format(p.amount) }}</td>
      <td><a href="{{ url_for('edit_purchase', purchase_id=p.id) }}">編集</a></td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}


{% block body_extra %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const supplierSelect = document.getElementById("supplier_id");
  const tbody = document.getElementById("item-rows");

  let baseItems = [];

  /* ===============================
     Load items by supplier
  =============================== */
  function loadItems(supplierId) {
    baseItems = [];
    if (!supplierId) return;

    fetch(`/api/items/by_supplier/${supplierId}`)
      .then(r => r.json())
      .then(data => {
        baseItems = Array.isArray(data) ? data : [];
      });
  }

  if (supplierSelect) {
    if (supplierSelect.value) loadItems(supplierSelect.value);
    supplierSelect.addEventListener("change", e => {
      loadItems(e.target.value);
    });
  }

  /* ===============================
     Autocomplete logic
  =============================== */
  function buildSuggestions(input, hidden, box) {
    const q = input.value.trim().toLowerCase();
    box.innerHTML = "";
    if (!q || baseItems.length === 0) {
      box.style.display = "none";
      return;
    }

    const matched = baseItems.filter(it => {
      const text = `${it.code || ""} ${it.name || ""}`.toLowerCase();
      return text.includes(q);
    }).slice(0, 30);

    if (matched.length === 0) {
      box.style.display = "none";
      return;
    }

    matched.forEach((it, idx) => {
      const div = document.createElement("div");
      div.textContent = `${it.code || ""} ${it.name}`;
      div.dataset.id = it.id;
      div.dataset.unit = it.unit ?? "";
      if (idx === 0) div.classList.add("active");

      div.addEventListener("mousedown", () => {
        selectItem(input, hidden, box, it);
      });

      box.appendChild(div);
    });

    box.style.display = "block";
  }

  function selectItem(input, hidden, box, item) {
    input.value = `${item.code || ""} ${item.name}`;
    hidden.value = item.id;
    box.style.display = "none";

    const tr = input.closest("tr");
    const qty = tr.querySelector(".qty-input");
    if (qty && !qty.value && item.unit) qty.value = item.unit;
    if (qty) qty.focus();
  }

  /* ===============================
     Keyboard control
  =============================== */
  tbody.addEventListener("keydown", e => {
    const input = e.target;
    if (!input.classList.contains("item-autocomplete")) return;

    const box = input.closest(".item-cell").querySelector(".item-suggestions");
    const items = [...box.querySelectorAll("div")];
    if (items.length === 0) return;

    let idx = items.findIndex(d => d.classList.contains("active"));

    if (e.key === "ArrowDown") {
      e.preventDefault();
      items[idx]?.classList.remove("active");
      idx = Math.min(idx + 1, items.length - 1);
      items[idx].classList.add("active");
    }

    if (e.key === "ArrowUp") {
      e.preventDefault();
      items[idx]?.classList.remove("active");
      idx = Math.max(idx - 1, 0);
      items[idx].classList.add("active");
    }

    if (e.key === "Enter") {
      e.preventDefault();
      items[idx].dispatchEvent(new MouseEvent("mousedown"));
    }
  });

  /* ===============================
     Input handler
  =============================== */
  tbody.addEventListener("input", e => {
    const input = e.target;
    if (!input.classList.contains("item-autocomplete")) return;

    const cell = input.closest(".item-cell");
    const hidden = cell.querySelector(".item-id");
    const box = cell.querySelector(".item-suggestions");

    hidden.value = "";
    buildSuggestions(input, hidden, box);
  });

  /* ===============================
     Click outside → close
  =============================== */
  document.addEventListener("click", e => {
    document.querySelectorAll(".item-suggestions").forEach(box => {
      if (!box.contains(e.target)) box.style.display = "none";
    });
  });
});
  function openSuggestions(input) {
  const wrap = input.closest(".item-cell");
  const box  = wrap.querySelector(".item-suggestions");

  if (!box || box.children.length === 0) return;

  box.hidden = false;

  // highlight first item
  const first = box.querySelector(".suggest-item");
  if (first) {
    first.classList.add("active");
  }
}
  tbody.addEventListener("keydown", function (e) {
  const input = e.target;
  if (!input.classList.contains("item-autocomplete")) return;

  const cell = input.closest(".item-cell");
  const box  = cell.querySelector(".item-suggestions");
  const items = box ? Array.from(box.querySelectorAll(".suggest-item")) : [];

  if (!box || items.length === 0) return;

  let index = items.findIndex(el => el.classList.contains("active"));

  /* ↓ open / move down */
  if (e.key === "ArrowDown") {
    e.preventDefault();

    if (box.hidden) {
      openSuggestions(input);
      return;
    }

    items.forEach(el => el.classList.remove("active"));
    index = Math.min(index + 1, items.length - 1);
    items[index].classList.add("active");
    items[index].scrollIntoView({ block: "nearest" });
  }

  /* ↑ move up */
  if (e.key === "ArrowUp") {
    e.preventDefault();
    items.forEach(el => el.classList.remove("active"));
    index = Math.max(index - 1, 0);
    items[index].classList.add("active");
    items[index].scrollIntoView({ block: "nearest" });
  }

  /* Enter = select */
  if (e.key === "Enter") {
    e.preventDefault();
    if (index >= 0) {
      items[index].click();   // reuse click handler
    }
  }

  /* Esc = close */
  if (e.key === "Escape") {
    box.hidden = true;
    items.forEach(el => el.classList.remove("active"));
  }
});
</script>
{% endblock %}
