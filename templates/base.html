<!DOCTYPE html>
<html lang="{{ lang }}">
  <head>
    <meta charset="UTF-8" />
    <title>{% block title %}TEST Dev{% endblock %}</title>

    <style>
      /* ============================
         全体レイアウト / 環境別背景色
      ============================ */

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 40px;
      }

      /* dev / mail / prod で背景色変える */
      body.env-dev {
        background: #f5fff8; /* 開発用：うっすら緑 */
      }
      body.env-mail {
        background: #fff8f0; /* メール／検証用：うっすらオレンジ */
      }
      body.env-prod {
        background: #ffffff; /* 本番：白 */
      }

      h1 {
        margin-bottom: 24px;
      }

      /* ============================
         横タブメニュー
      ============================ */

      .nav-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 18px;
        list-style: none;
        padding: 0;
        margin: 0 0 30px 0;
        border-bottom: 2px solid #ddd;
      }

      .nav-tabs li {
        margin: 0;
      }

      .nav-tabs a {
        display: inline-block;
        padding: 8px 14px;
        text-decoration: none;
        color: #333;
        font-weight: 600;
        border-radius: 6px 6px 0 0;
      }

      .nav-tabs a:hover {
        background: #f0f0f0;
      }

      /* アクティブタブ：ヘッダー行と同じ色に */
      .nav-tabs a.active {
        background: #f0f4ff; /* ヘッダーと揃える */
        border-bottom: 2px solid #f0f4ff;
      }

      /* ============================
         flash メッセージ
      ============================ */

      .flash {
        background: #ffeebb;
        border: 1px solid #e0c97f;
        padding: 10px 16px;
        margin: 20px 0;
        border-radius: 6px;
      }

      /* ============================
         テーブル共通デザイン
      ============================ */

       /* ラベルの幅を揃える用（フォームヘッダーなど） */
      .field-label {
        display: inline-block;
        width: 4em;   /* 必要に応じて 4em → 5em など微調整 */
      }
      table {
        border-collapse: collapse;
        width: auto; /* データ幅に合わせる */
        max-width: 100%;
        margin-top: 20px;
      }

      table th,
      table td {
        padding: 6px 10px;
        border: 1px solid #ddd;
      }

      /* ヘッダー行 */
      table thead tr {
        background: #f0f4ff; /* 薄い青 */
        font-weight: bold;
        border-bottom: 2px solid #b8c6e6;
      }

      /* TH は左寄せ */
      table th {
        text-align: left !important;
      }

      /* 交互行ストライプ */
      table tbody tr:nth-child(odd) {
        background: #ffffff;
      }
      table tbody tr:nth-child(even) {
        background: #f7f7f7;
      }

      /* 行ホバー */
      table tbody tr:hover {
        background: #e8f2ff;
      }

      /* 合計行（tfoot または .total-row） */
      table tfoot tr,
      .total-row {
        background: #fff8d5; /* 薄い黄色 */
        font-weight: bold;
        border-top: 2px solid #e0cd99;
      }

      /* 数値を右寄せにする共通クラス */
      table td.num,
      input.num,
      .qty-input,
      .price-input,
      .amount-display {
        text-align: right !important;
      }

      /* ============================
         月次利用量（usage_report）専用
      ============================ */
      
      table.monthly-table.usage-table {
        margin-top: 20px;
      }
      
      /* usage_table ではストライプはリセットして自前で塗る */
      table.monthly-table.usage-table tbody tr:nth-child(odd),
      table.monthly-table.usage-table tbody tr:nth-child(even) {
        background: #ffffff;
      }
      
      table.monthly-table.usage-table th,
      table.monthly-table.usage-table td {
        white-space: nowrap;
      }
      
      /* 左端：品目名、2列目：指標ラベルは左寄せ */
      table.monthly-table.usage-table th:first-child,
      table.monthly-table.usage-table td:first-child,
      table.monthly-table.usage-table td.metric-label {
        text-align: left !important;
      }
      
      /* 指標ごとに色替え */
      table.monthly-table.usage-table .row-metric-pur td {
        /* 当月仕入：白のまま */
      }
      
      table.monthly-table.usage-table .row-metric-use td {
        background: #fff8e8;          /* 利用数（差引）を強調 */
        font-weight: 600;
      }
      
      table.monthly-table.usage-table .row-metric-stock td {
        background: #fafafa;          /* 次月繰越 在庫 */
      }
      
      /* ★ 品目ごとの区切り線を「太線」にする（3行目＝在庫行の下） */
      table.monthly-table.usage-table tr.row-metric-stock td {
        border-bottom: 2px solid #999;
      }      
      /* ============================
         売上原価（cost_report）専用
      ============================ */

      /* 売上原価の行を少し強調 */
      tr.cogs-row td {
        background: #fff8d5;
        font-weight: bold;
      }

      tr.cogs-row td:first-child {
        text-align: left !important;
      }
    </style>

    <!-- ★ 共通JSヘルパー（全角→半角 & 数値パース）★ -->
    <script>
      window.KURAJIKA = window.KURAJIKA || {};

      // 全角数字＋カンマなどを半角数字だけの文字列に正規化
      window.KURAJIKA.toHalfWidthNum = function (str) {
        if (str == null) return "";
        let s = String(str);

        // 全角数字 → 半角数字
        s = s.replace(/[０-９]/g, function (c) {
          return String.fromCharCode(c.charCodeAt(0) - 0xFEE0);
        });

        // 全角・半角カンマを削除
        s = s.replace(/[，,]/g, "");

        // 数字とマイナス以外は削除（念のため）
        s = s.replace(/[^\d\-]/g, "");

        return s;
      };

      // input 要素の値を「半角数字のみ」に正規化してから、数値として返す
      window.KURAJIKA.parseNum = function (inputEl) {
        if (!inputEl) return 0;
        const raw = inputEl.value || "";
        const normalized = window.KURAJIKA.toHalfWidthNum(raw);

        // 入力欄の表示も半角に揃える
        inputEl.value = normalized;

        if (!normalized) return 0;
        const n = parseInt(normalized, 10);
        return isNaN(n) ? 0 : n;
      };

      // 単に「この input を半角数字にクリーンアップ」するだけのヘルパー
      window.KURAJIKA.normalizeNumInput = function (inputEl) {
        if (!inputEl) return;
        const raw = inputEl.value || "";
        const normalized = window.KURAJIKA.toHalfWidthNum(raw);
        if (raw !== normalized) {
          inputEl.value = normalized;
        }
      };

      // すべての数値用 input（class="num"）で、入力のたびに全角→半角変換
      document.addEventListener("input", function (e) {
        const el = e.target;
        if (el.matches("input.num")) {
          window.KURAJIKA.normalizeNumInput(el);
        }
      });
        </script>
    <!-- ★ ここまで追加 ★ -->

    {% block head_extra %}{% endblock %}

  
  </head>

  {# APP_ENV に応じて body クラスを切り替え（app.py 側で APP_ENV を設定しておく想定） #}
  <body
    class="
      {% if config.APP_ENV == 'prod' %}
        env-prod
      {% elif config.APP_ENV == 'mail' %}
        env-mail
      {% else %}
        env-dev
      {% endif %}
    "
  >
     <form method="post" action="{{ url_for('set_lang') }}" style="display:inline;">
  <input type="hidden" name="next" value="{{ request.path }}">
  <select name="lang" onchange="this.form.submit()">
    {% for code in supported_langs %}
      <option value="{{ code }}" {% if lang == code %}selected{% endif %}>
        {{ code.upper() }}
      </option>
    {% endfor %}
  </select>
</form>
    <h1>TEST test tst 倉島事業開発 CMS PostGres Dev Env</h1>

    {# flash メッセージ #}
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash">
          {% for msg in messages %}
            <div>{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- ============================
         横タブメニュー（全画面共通）
    ============================ -->
<nav>
  <ul class="nav-tabs">
    <li>
      <a
        href="{{ url_for('new_purchase') }}"
        class="{% if request.endpoint in ['new_purchase', 'edit_purchase'] %}active{% endif %}"
      >
        {{ t("nav.purchase_form") }}
      </a>
    </li>

    <li>
      <a
        href="{{ url_for('inventory_count') }}"
        class="{% if request.endpoint == 'inventory_count' %}active{% endif %}"
      >
        {{ t("nav.inventory_count") }}
      </a>
    </li>

    <li>
      <a
        href="{{ url_for('reports.purchase_report') }}"
        class="{% if request.endpoint in ['purchase_report', 'purchase_report_supplier'] %}active{% endif %}"
      >
        {{ t("nav.purchase_report") }}
      </a>
    </li>

    <li>
      <a
        href="{{ url_for('reports.usage_report') }}"
        class="{% if request.endpoint == 'usage_report' %}active{% endif %}"
      >
        {{ t("nav.usage_report") }}
      </a>
    </li>

    <li>
      <a
        href="{{ url_for('reports.cost_report') }}"
        class="{% if request.endpoint == 'cost_report' %}active{% endif %}"
      >
        {{ t("nav.cost_report") }}
      </a>
    </li>

    <li>
      <a
        href="{{ url_for('suppliers_master') }}"
        class="{% if request.endpoint == 'suppliers_master' %}active{% endif %}"
      >
        {{ t("nav.suppliers_master") }}
      </a>
    </li>

    <li>
      <a
        href="{{ url_for('items_master') }}"
        class="{% if request.endpoint in ['items_master', 'edit_item'] %}active{% endif %}"
      >
        {{ t("nav.items_master") }}
      </a>
    </li>

    <li>
      <a
        href="{{ url_for('stores_master') }}"
        class="{% if request.endpoint in ['stores_master', 'edit_store'] %}active{% endif %}"
      >
        {{ t("nav.stores_master") }}
      </a>
    </li>
  </ul>
</nav>

    {% block content %}{% endblock %}
    {% block body_extra %}{% endblock %}
  </body>
</html>
