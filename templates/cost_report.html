<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>売上原価 月次推移</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 20px;
      }
      h1 {
        font-size: 22px;
        margin-bottom: 8px;
      }
      a {
        text-decoration: none;
        color: #0366d6;
      }
      a:hover {
        text-decoration: underline;
      }
      form {
        margin-bottom: 16px;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      label {
        margin-right: 12px;
      }
      select {
        padding: 2px 4px;
        font-size: 13px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 12px;
        font-size: 13px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 3px 4px;
      }
      th {
        background: #f5f5f5;
        white-space: nowrap;
      }
      td.right,
      th.right {
        text-align: right;
      }
      .row-header {
        background: #fafafa;
        font-weight: bold;
        white-space: nowrap;
      }
      .row-cogs {
        background: #fffde7;
        font-weight: bold;
      }
      .total-col {
        background: #eee;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>売上原価 月次推移</h1>

    <p>
      <a href="{{ url_for('index') }}">← メニューへ戻る</a> |
      <a href="{{ url_for('purchase_report') }}">仕入れ照会（月次）</a> |
      <a href="{{ url_for('new_purchase') }}">仕入れ入力</a>
    </p>

    <!-- 店舗選択フォーム（GET） -->
    <form method="get" action="{{ url_for('cost_report') }}">
      <label>
        店舗：
        <select name="store_id">
          <option value="">全店舗</option>
          {% for s in stores %}
          <option
            value="{{ s['id'] }}"
            {% if selected_store_id and s['id'] == selected_store_id %}selected{% endif %}
          >
            {{ s['name'] }}
          </option>
          {% endfor %}
        </select>
      </label>

      <span style="margin-left:12px; font-size: 12px; color:#555;">
        対象期間：直近13ヶ月（月次）
      </span>

      <button type="submit" style="margin-left: 12px;">再表示</button>
    </form>

    <table>
      <thead>
        <tr>
          <th class="row-header">区分</th>
          {% for ym in month_keys %}
          <th class="right">{{ ym }}</th>
          {% endfor %}
          <th class="right total-col">合計</th>
        </tr>
      </thead>
      <tbody>
        <!-- 期首繰越 -->
        <tr>
          <td class="row-header">期首繰越</td>
          {% for ym in month_keys %}
          <td class="right">
            {% set v = beg_inv_by_month.get(ym, 0) %}
            {% if v %}
              {{ "{:,}".format(v|round|int) }}
            {% endif %}
          </td>
          {% endfor %}
          <td class="right total-col">
            {% if beg_total %}
              {{ "{:,}".format(beg_total|round|int) }}
            {% endif %}
          </td>
        </tr>

        <!-- 仕入額 -->
        <tr>
          <td class="row-header">仕入額</td>
          {% for ym in month_keys %}
          <td class="right">
            {% set v = purchases_by_month.get(ym, 0) %}
            {% if v %}
              {{ "{:,}".format(v|round|int) }}
            {% endif %}
          </td>
          {% endfor %}
          <td class="right total-col">
            {% if pur_total %}
              {{ "{:,}".format(pur_total|round|int) }}
            {% endif %}
          </td>
        </tr>

        <!-- 売上原価 -->
        <tr class="row-cogs">
          <td class="row-header">売上原価</td>
          {% for ym in month_keys %}
          <td class="right">
            {% set v = cogs_by_month.get(ym, 0) %}
            {% if v %}
              {{ "{:,}".format(v|round|int) }}
            {% endif %}
          </td>
          {% endfor %}
          <td class="right total-col">
            {% if cogs_total %}
              {{ "{:,}".format(cogs_total|round|int) }}
            {% endif %}
          </td>
        </tr>

        <!-- 月末棚卸し -->
        <tr>
          <td class="row-header">月末棚卸し</td>
          {% for ym in month_keys %}
          <td class="right">
            {% set v = end_inv_by_month.get(ym, 0) %}
            {% if v %}
              {{ "{:,}".format(v|round|int) }}
            {% endif %}
          </td>
          {% endfor %}
          <td class="right total-col">
            {% if end_total %}
              {{ "{:,}".format(end_total|round|int) }}
            {% endif %}
          </td>
        </tr>
      </tbody>
    </table>
  </body>
</html>