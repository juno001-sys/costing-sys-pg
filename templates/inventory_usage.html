<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>月次利用量照会（仕入＋棚卸ベース）</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 20px;
      }
      h1 {
        font-size: 22px;
        margin-bottom: 8px;
      }
      a {
        text-decoration: none;
        color: #0366d6;
      }
      a:hover {
        text-decoration: underline;
      }
      form {
        margin-bottom: 16px;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      label {
        margin-right: 12px;
      }
      select {
        padding: 2px 4px;
        font-size: 13px;
      }
      button {
        padding: 4px 12px;
        font-size: 13px;
        margin-left: 8px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 12px;
        font-size: 12px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 3px 4px;
      }
      th {
        background: #f5f5f5;
        white-space: nowrap;
      }
      td.right,
      th.right {
        text-align: right;
      }
      /* 品目切り替わりの区切り線を濃くする */
      .row-purchase {
        border-top: 2px solid #666 !important;
        }
      .row-stock {
        background: #f9f9f9;
      }
      .row-usage {
        background: #fff7e6;
      }
      .col-item {
        width: 18%;
      }
      .col-type {
        width: 6%;
        white-space: nowrap;
      }
      .note {
        font-size: 11px;
        color: #666;
        margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <h1>月次利用量照会（仕入＋棚卸ベース）</h1>

    <p>
      <a href="{{ url_for('index') }}">← メニューへ戻る</a> |
      <a href="{{ url_for('new_purchase') }}">仕入れ入力</a> |
      <a href="{{ url_for('inventory_count') }}">棚卸し入力</a>
    </p>

    <!-- 店舗選択フォーム -->
    <form method="get" action="{{ url_for('inventory_usage') }}">
      <label>
        店舗：
        <select name="store_id">
          <option value="">全店舗</option>
          {% for s in stores %}
          <option
            value="{{ s['id'] }}"
            {% if selected_store_id and s['id'] == selected_store_id %}selected{% endif %}
          >
            {{ s['name'] }}
          </option>
          {% endfor %}
        </select>
      </label>

      <button type="submit">表示</button>

      <div class="note">
        ※ 直近13ヶ月分が表示されます。<br />
        利用数量 = 前月棚卸数量 + 当月仕入数量 − 当月棚卸数量（棚卸が無い月は在庫0とみなす）
      </div>
    </form>

    {% if item_rows %}
    <table>
      <thead>
        <tr>
          <th class="col-item">品目</th>
          <th class="col-type">指標</th>
          {% for ym in month_keys %}
          <th class="right">{{ ym }}</th>
          {% endfor %}
          <th class="right">合計</th>
        </tr>
      </thead>
      <tbody>
        {% for row in item_rows %}
        <!-- 仕入数量の行 -->
        <tr class="row-purchase">
          <td class="col-item" rowspan="3">{{ row["item_name"] }}</td>
          <td class="col-type">当月仕入数</td>
          {% set total_p = 0 %}
          {% for ym in month_keys %}
            {% set v = row["purchases"].get(ym, 0) %}
            {% set total_p = total_p + v %}
            <td class="right">
              {% if v %}
                {{ v }}
              {% endif %}
            </td>
          {% endfor %}
          <td class="right">
            {% if total_p %}
              {{ total_p }}
            {% endif %}
          </td>
        </tr>

        <!-- 利用数量の行 -->
        <tr class="row-usage">
          <td class="col-type">利用数(差引) 
          </td>
          {% set total_u = 0 %}
          {% for ym in month_keys %}
            {% set v = row["usage"].get(ym, 0) %}
            {% set total_u = total_u + v %}
            <td class="right">
              {% if v %}
                {{ v }}
              {% endif %}
            </td>
          {% endfor %}
          <td class="right">
            {% if total_u %}
              {{ total_u }}
            {% endif %}
          </td>
        </tr>

        <!-- 棚卸数量の行 -->
        <tr class="row-stock">
          <td class="col-type">棚卸数（次月繰越）</td>
          {% set dummy = 0 %}
          {% for ym in month_keys %}
            {% set v = row["stocks"].get(ym, 0) %}
            <td class="right">
              {% if v %}
                {{ v }}
              {% endif %}
            </td>
          {% endfor %}
          <td class="right"></td>
        </tr>

        
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>該当するデータがありません。</p>
    {% endif %}
  </body>
</html>